<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nightmare Escape</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

</head>

<body style="margin:0; overflow:hidden; touch-action:none;">

<a-scene embedded arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

<a-marker preset="hiro">

<!-- TITLE (far above interaction zone) -->

<a-text
value="Nightmare Escape"
position="0 1.8 0"
rotation="-90 0 0"
scale="0.7 0.7 0.7"
color="#ff66ff">
</a-text>

<!-- DAGGER 1 -->

<a-entity position="-0.8 0.3 0" rotation="-90 0 0">

  <!-- visible blade -->
  <a-box id="d1blade" depth="0.05" height="0.5" width="0.1" color="red"></a-box>

  <!-- invisible giant hitbox -->
  <a-box id="d1hit" depth="0.3" height="0.7" width="0.5"
         color="white" opacity="0" transparent="true"></a-box>

  <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
  <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>

</a-entity>

<!-- DAGGER 2 -->

<a-entity position="0 0.3 0" rotation="-90 0 0">

  <a-box id="d2blade" depth="0.05" height="0.5" width="0.1" color="blue"></a-box>

  <a-box id="d2hit" depth="0.3" height="0.7" width="0.5"
         color="white" opacity="0" transparent="true"></a-box>

  <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
  <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>

</a-entity>

<!-- DAGGER 3 -->

<a-entity position="0.8 0.3 0" rotation="-90 0 0">

  <a-box id="d3blade" depth="0.05" height="0.5" width="0.1" color="green"></a-box>

  <a-box id="d3hit" depth="0.3" height="0.7" width="0.5"
         color="white" opacity="0" transparent="true"></a-box>

  <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
  <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>

</a-entity>

<!-- REWARD -->

<a-text id="reward"
value="H"
position="0 2.2 0"
rotation="-90 0 0"
scale="1.2 1.2 1.2"
color="gold"
visible="false">
</a-text>

</a-marker>

<a-entity camera></a-entity>

</a-scene>

<script>

const colors = ["red","blue","green","yellow"];
let state = [0,1,2];

function cycle(bladeId,i){
  state[i] = (state[i]+1)%colors.length;
  document.querySelector(bladeId).setAttribute("color", colors[state[i]]);
  checkWin();
}

function checkWin(){
  if(state[0]===state[1] && state[1]===state[2]){
    document.querySelector("#reward").setAttribute("visible", true);
  }
}

/* ---------- GIANT MOBILE HIT DETECTION ---------- */

window.addEventListener("load", () => {

  const scene = document.querySelector("a-scene");

  scene.addEventListener("touchstart", (e) => {

    if (!scene.camera) return;

    const touch = e.touches[0];

    const mouse = new THREE.Vector2(
      (touch.clientX / window.innerWidth) * 2 - 1,
      -(touch.clientY / window.innerHeight) * 2 + 1
    );

    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, scene.camera);

    const targets = [
      document.querySelector("#d1hit").object3D,
      document.querySelector("#d2hit").object3D,
      document.querySelector("#d3hit").object3D
    ];

    const hits = raycaster.intersectObjects(targets, true);

    if (hits.length === 0) return;

    const id = hits[0].object.el.id;

    if(id === "d1hit") cycle("#d1blade",0);
    if(id === "d2hit") cycle("#d2blade",1);
    if(id === "d3hit") cycle("#d3blade",2);

  });

});

</script>

</body>
</html>
