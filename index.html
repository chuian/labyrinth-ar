<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Nightmare Escape - Stable</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0; overflow:hidden; touch-action:none;">

    <a-scene 
        embedded 
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false">

        <a-entity camera>
            <a-entity id="reticle"
                cursor="fuse: false"
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.015; radiusOuter: 0.025"
                material="color: #ff66ff; shader: flat; opacity: 0.8"
                raycaster="objects: .clickable">
                <a-circle radius="0.005" color="#ff66ff"></a-circle>
            </a-entity>
        </a-entity>

        <a-marker preset="hiro" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">

            <a-text 
                value="Nightmare Escape" 
                position="0 0.8 -0.4" 
                rotation="-90 0 0" 
                align="center" 
                scale="0.5 0.5 0.5" 
                color="#ff66ff">
            </a-text>

            <a-entity id="dagger1" position="-0.4 0.2 0" rotation="-90 0 0" scale="0.8 0.8 0.8">
                <a-box id="d1blade" depth="0.05" height="0.5" width="0.1" color="red"></a-box>
                <a-box id="d1hit" class="clickable" depth="0.4" height="0.6" width="0.4" opacity="0" transparent="true"></a-box>
                <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
                <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>
            </a-entity>

            <a-entity id="dagger2" position="0 0.2 0" rotation="-90 0 0" scale="0.8 0.8 0.8">
                <a-box id="d2blade" depth="0.05" height="0.5" width="0.1" color="blue"></a-box>
                <a-box id="d2hit" class="clickable" depth="0.4" height="0.6" width="0.4" opacity="0" transparent="true"></a-box>
                <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
                <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>
            </a-entity>

            <a-entity id="dagger3" position="0.4 0.2 0" rotation="-90 0 0" scale="0.8 0.8 0.8">
                <a-box id="d3blade" depth="0.05" height="0.5" width="0.1" color="green"></a-box>
                <a-box id="d3hit" class="clickable" depth="0.4" height="0.6" width="0.4" opacity="0" transparent="true"></a-box>
                <a-box depth="0.05" height="0.05" width="0.2" position="0 -0.25 0" color="#222"></a-box>
                <a-box depth="0.03" height="0.2" width="0.05" position="0 -0.4 0" color="#111"></a-box>
            </a-entity>

            <a-entity id="reward" visible="false" position="0 1 0" rotation="-90 0 0">
                <a-text value="H" align="center" color="gold" scale="3 3 3"></a-text>
                <a-torus color="gold" radius="0.3" radius-tubular="0.01" 
                          animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
                </a-torus>
            </a-entity>

        </a-marker>

    </a-scene>

    <script>
        const colors = ["red", "blue", "green", "yellow"];
        let state = [0, 1, 2];

        function handleInteraction(index) {
            state[index] = (state[index] + 1) % colors.length;
            const blade = document.querySelector(`#d${index + 1}blade`);
            blade.setAttribute("color", colors[state[index]]);

            const dagger = document.querySelector(`#dagger${index + 1}`);
            dagger.removeAttribute('animation'); 
            dagger.setAttribute('animation', {
                property: 'scale',
                from: '1 1 1',
                to: '0.8 0.8 0.8',
                dur: 150,
                easing: 'easeInQuad'
            });

            checkWin();
        }

        function checkWin() {
            const reward = document.querySelector("#reward");
            const isWin = (state[0] === state[1] && state[1] === state[2]);
            reward.setAttribute("visible", isWin);
        }

        window.onload = () => {
            const hits = ["#d1hit", "#d2hit", "#d3hit"];
            hits.forEach((selector, i) => {
                const el = document.querySelector(selector);
                // click and mousedown for broad compatibility
                el.addEventListener('mousedown', () => handleInteraction(i));
            });
        };
    </script>
</body>
</html>
